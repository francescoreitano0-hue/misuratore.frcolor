
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Irina - Misuratore Finale</title>
    <style>
        /* CSS INTEGRATO PER EVITARE ERRORI DI CARICAMENTO */
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; color: white; }
        video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }
        #interface { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box; pointer-events: none; }
        #top-info { background: rgba(0,0,0,0.7); padding: 10px; border-radius: 10px; text-align: center; pointer-events: auto; }
        #display { font-size: 60px; font-weight: bold; color: #0f0; text-align: center; text-shadow: 2px 2px #000; }
        #controls { display: flex; flex-direction: column; gap: 15px; align-items: center; pointer-events: auto; }
        .btn { width: 80%; padding: 20px; font-size: 20px; font-weight: bold; border-radius: 50px; border: none; cursor: pointer; text-transform: uppercase; }
        #btn-main { background: #2196F3; color: white; box-shadow: 0 4px 15px rgba(33,150,243,0.5); }
        #btn-reset { background: #f44336; color: white; width: 40%; padding: 10px; font-size: 14px; }
        #log { background: rgba(255,255,255,0.9); color: #333; border-radius: 10px; max-height: 100px; overflow-y: auto; padding: 10px; pointer-events: auto; margin-top: 10px; }
        input { width: 60px; font-size: 18px; padding: 5px; text-align: center; }
    </style>
</head>
<body>

    <video id="webcam" autoplay playsinline></video>

    <div id="interface">
        <div id="top-info">
            <div id="status">Punta la base dell'oggetto</div>
            <div id="display">0.00 m</div>
            <div>
                Tua altezza (m): 
                <input type="number" id="userH" value="1.60" step="0.01">
            </div>
        </div>

        <div id="controls">
            <div id="log"><strong>Misure:</strong><div id="list"></div></div>
            <button id="btn-main" class="btn">PUNTA BASE</button>
            <button id="btn-reset" class="btn">RESET</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('webcam');
        const btnMain = document.getElementById('btn-main');
        const btnReset = document.getElementById('btn-reset');
        const display = document.getElementById('display');
        const status = document.getElementById('status');
        const list = document.getElementById('list');
        const userHInput = document.getElementById('userH');

        let baseAngle = null;
        let currentPitch = 0;

        // 1. ATTIVAZIONE CAMERA
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                video.srcObject = stream;
            } catch (err) {
                alert("Errore Camera: Assicurati di usare HTTPS e dare i permessi.");
            }
        }

        // 2. ATTIVAZIONE SENSORI (Giroscopio)
        function startSensors() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => { if (response == 'granted') window.addEventListener('deviceorientation', handleOrientation); })
                    .catch(console.error);
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        function handleOrientation(event) {
            // Beta Ã¨ l'inclinazione avanti/dietro
            currentPitch = event.beta;
        }

        // 3. LOGICA DI MISURA (Trigonometria)
        btnMain.onclick = () => {
            startSensors(); // Attiva i sensori al primo click
            const h = parseFloat(userHInput.value);

            if (baseAngle === null) {
                // Fissiamo il punto a terra
                baseAngle = currentPitch;
                btnMain.textContent = "PUNTA CIMA";
                btnMain.style.background = "#FF9800";
                status.textContent = "Base fissata. Ora punta in alto.";
                
                // Calcola distanza per feedback
                const dist = h * Math.tan((90 - baseAngle) * Math.PI / 180);
                display.textContent = Math.abs(dist).toFixed(2) + " m";
            } else {
                // Fissiamo la cima e calcoliamo l'altezza totale
                const topAngle = currentPitch;
                
                const radBase = (90 - baseAngle) * Math.PI / 180;
                const distance = h * Math.tan(radBase);
                
                // Formula: Altezza = Distanza * (tan(angolo_cima - angolo_base)) + Altezza_Utente
                const angleDiff = (topAngle - baseAngle) * Math.PI / 180;
                const finalHeight = Math.abs(h + (distance * Math.tan(angleDiff)));

                display.textContent = finalHeight.toFixed(2) + " m";
                
                const entry = document.createElement('div');
                entry.textContent = `H: ${finalHeight.toFixed(2)} m (Dist: ${Math.abs(distance).toFixed(2)}m)`;
                list.prepend(entry);

                // Reset per nuova misura
                baseAngle = null;
                btnMain.textContent = "PUNTA BASE";
                btnMain.style.background = "#2196F3";
                status.textContent = "Misura salvata. Ricomincia dalla base.";
            }
        };

        btnReset.onclick = () => {
            baseAngle = null;
            display.textContent = "0.00 m";
            btnMain.textContent = "PUNTA BASE";
            btnMain.style.background = "#2196F3";
            list.innerHTML = "";
        };

        startCamera();
    </script>
</body>
</html>
